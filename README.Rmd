---
title: "README"
author: "Anna Hutchinson"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(cowplot)
library(dplyr)
```

---

### Aim

---

Investigate the utility of incorporating functional annotation data for fine-mapping causal variants using PAINTOR.

---

### Method

---

Simulate loci that reach genome-wide significance and corresponding binary annotation vectors, where 5% of the SNPs are randomly allocated the annotation.

Run PAINTOR on various combinations of the simulated loci, where the proportion of CVs with the annotation varies across combinations. The annotation is uninformative in combinations where the annotation is present in 5% of the CVs (as this is its proportion genome-wide) and becomes more informative as the number of CVs with the annotation increases in that specific combination of simulated loci.

---

### Code

---

The code to run this analysis is avaliable in the /code directory of this github repository. The files should be run in the following order:

1. `simulate_loci.R`

2. `make_loci_combinations.R`

3. `run_PAINTOR`

4. `make_finalres.R`

---

### Results

---

```{r warning = FALSE, message=FALSE, comment = FALSE, echo = FALSE, fig.width = 10, fig.height = 7}
x <- readRDS("res/fullres.RDS")

x$prop <- as.factor(x$prop)

quantiles_low <- within(x[which(x$ld == "low"),], quantile <- as.integer(cut(max_Z, quantile(max_Z, probs=0:5/5), include.lowest=TRUE)))

quantiles_low_values <- quantile(x[which(x$ld == "low"),"max_Z"], probs=0:5/5)

quantiles_medium <- within(x[which(x$ld == "medium"),], quantile <- as.integer(cut(max_Z, quantile(max_Z, probs=0:5/5), include.lowest=TRUE)))

quantiles_medium_values <- quantile(x[which(x$ld == "medium"),"max_Z"], probs=0:5/5)

quantiles_high <- within(x[which(x$ld == "high"),], quantile <- as.integer(cut(max_Z, quantile(max_Z, probs=0:5/5), include.lowest=TRUE)))

quantiles_high_values <- quantile(x[which(x$ld == "high"),"max_Z"], probs=0:5/5)

new.df_low <- quantiles_low %>%
  group_by(prop, quantile) %>%
  summarise(PP_mean = mean(PPs), PP_median = median(PPs), se = se(PPs))

new.df_medium <- quantiles_medium %>%
  group_by(prop, quantile) %>%
  summarise(PP_mean = mean(PPs), PP_median = median(PPs), se = se(PPs))

new.df_high <- quantiles_high %>%
  group_by(prop, quantile) %>%
  summarise(PP_mean = mean(PPs), PP_median = median(PPs), se = se(PPs))

new.df_low$Quantile <- as.factor(new.df_low$quantile)
new.df_medium$Quantile <- as.factor(new.df_medium$quantile)
new.df_high$Quantile <- as.factor(new.df_high$quantile)

low_mean <- ggplot(new.df_low, aes(x = prop, y = PP_mean, col = Quantile, group = quantile))+geom_line()+ theme_cowplot(12) +theme(plot.title = element_text(color="black", face="bold", size = 12, hjust=0.5)) + background_grid(major = "xy", minor = "none") + ggtitle("Low LD")+ ylab("Mean PP at CV +/- 1.96 * SE")+ theme(legend.position = "none")+ 
  geom_ribbon(aes(ymin=PP_mean-1.96*se, ymax=PP_mean+1.96*se), alpha=0.1, colour = NA) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + xlab("Proportion of CVs with annotation")

medium_mean <- ggplot(new.df_medium, aes(x = prop, y = PP_mean, col = Quantile, group = quantile))+geom_line()+ theme_cowplot(12) +theme(plot.title = element_text(color="black", face="bold", size = 12, hjust=0.5)) + background_grid(major = "xy", minor = "none") + ggtitle("Medium LD")+ ylab("")+ 
  geom_ribbon(aes(ymin=PP_mean-1.96*se, ymax=PP_mean+1.96*se), alpha=0.1, colour = NA) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + xlab("Proportion of CVs with annotation") + scale_colour_discrete(name = "Max abs Z score\nquantile", labels = c("0 - 0.2", "0.2 - 0.4", "0.4 - 0.6",  "0.6 - 0.8",  "0.8 - 1"))

high_mean <- ggplot(new.df_high, aes(x = prop, y = PP_mean, col = Quantile, group = quantile))+geom_line()+ theme_cowplot(12) +theme(plot.title = element_text(color="black", face="bold", size = 12, hjust=0.5)) + background_grid(major = "xy", minor = "none") + ggtitle("High LD")+ ylab("")+ theme(legend.position = "none")+ 
  geom_ribbon(aes(ymin=PP_mean-1.96*se, ymax=PP_mean+1.96*se), alpha=0.1, colour = NA) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + xlab("Proportion of CVs with annotation")

quantile_plot <- plot_grid(low_mean + coord_cartesian(ylim = c(0,1)), medium_mean + theme(legend.position = "none")+ coord_cartesian(ylim = c(0,1)), high_mean+ coord_cartesian(ylim = c(0,1)), nrow = 1)

legend <- get_legend(
  # create some space to the left of the legend
  medium_mean + theme(legend.box.margin = margin(0, 0, 0, 10))
)

final <- plot_grid(quantile_plot, legend, rel_widths = c(3, .5))

final

# ggsave("functional-annots.png",plot=final,height=8,width=12)

```

---